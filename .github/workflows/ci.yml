name: CI

on:
    push:
        branches: [main, develop, 'F-*']
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint-and-format:
        name: Lint & Format Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check formatting
              run: pnpm format:check

            - name: Run linters
              run: pnpm lint || echo "Lint script not configured yet, skipping..."
              continue-on-error: true

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run type checking
              run: pnpm typecheck

    test:
        name: Test
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [18, 20]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build packages
              run: pnpm build

            - name: Run tests
              run: pnpm test

            - name: Generate coverage report
              if: matrix.node-version == 20
              run: |
                  for pkg in packages/*/package.json; do
                    dir=$(dirname "$pkg")
                    if grep -q '"test:coverage"' "$pkg"; then
                      (cd "$dir" && pnpm test:coverage) || true
                    fi
                  done
              continue-on-error: true

            - name: Upload coverage to Codecov
              if: matrix.node-version == 20
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./packages/*/coverage/coverage-final.json
                  fail_ci_if_error: false
              continue-on-error: true

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint-and-format, typecheck]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build all packages
              run: pnpm build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      packages/*/dist
                  retention-days: 7

    ci-success:
        name: CI Success
        runs-on: ubuntu-latest
        needs: [lint-and-format, typecheck, test, build]
        if: always()

        steps:
            - name: Check job results
              run: |
                  if [[ "${{ needs.lint-and-format.result }}" != "success" ]] || \
                     [[ "${{ needs.typecheck.result }}" != "success" ]] || \
                     [[ "${{ needs.test.result }}" != "success" ]] || \
                     [[ "${{ needs.build.result }}" != "success" ]]; then
                    echo "One or more jobs failed"
                    exit 1
                  fi
                  echo "All jobs succeeded"
